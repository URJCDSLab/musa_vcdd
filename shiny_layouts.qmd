---
title: Dise√±o e interacci√≥n de usuario con Shiny
subtitle: "Visualizaci√≥n y Comunicaci√≥n de Datos Deportivos"
author: "M√°ster Universitario en An√°lisis de Datos Deportivos<br/>Universidad Rey Juan Carlos"
code-fold: false
---

# Paquetes y metapaquetes para dashboards

## Conjuntos de paquetes

* Proporcionan una estructura y un dise√±o predefinido

* Aceleran el desarrollo

* Automatizan tareas comunes

* Personalizaci√≥n limitada

* Ejemplos: [golemverse](https://golemverse.org), [rhinoverse](https://www.appsilon.com/rhinoverse), [leprechaun](https://leprechaun.opifex.org/#/)

## Ejemplo con Rhino

```{r}
#| eval: false
#| echo: true
# install.packages("rhino")
rhino::init("RhinoApplication")
setwd("./RhinoApplication")
shiny::runApp()
```


## Paquetes generalistas

* Menos dependientes de un dise√±o espec√≠fico

* [shinydashboard](https://rstudio.github.io/shinydashboard/). Obsoleto, pero a√∫n muy utilizado.

* [b4dash](https://github.com/ThinkR-open/b4dash). Basado en Bootstrap 4, m√°s moderno y flexible.

* [bslib](https://rstudio.github.io/bslib/). Permite crear temas personalizados para Shiny, incluyendo dashboards.

* [shinywidgets](https://shinywidgets.com/). Colecci√≥n de widgets y componentes para Shiny, incluyendo algunos para dashboards.

## App dentro de un paquete propio

* Recomendado para proyectos complejos o a largo plazo

* Facilita la organizaci√≥n del c√≥digo, la reutilizaci√≥n de componentes y la colaboraci√≥n

* Permite la integraci√≥n con otras funciones y datos del paquete

* Detalles: [https://mjfrigaard.github.io/shiny-app-pkgs/](https://mjfrigaard.github.io/shiny-app-pkgs/)

* IMPORTANTE: manejo de paquetes con `NAMESPACE`, no `library()`.



# Dise√±o (layouts)

## Estructura general de un dashboard
  
* Primero se define el tipo de p√°gina

* Dependiendo del tipo de p√°gina, puede incluir o no una barra lateral (incluso una a cada lado)

* Se puede a√±adir pie de p√°gina

* Panel principal: pensar en filas y columnas (_bootstrap grid system_, 12 columnas)

* Organizaci√≥n de panel principal y _sidebar_ con pesta√±as.

* Incluir elementos en _cards_ o _boxes_.


## Dise√±os de p√°gina

::: {.panel-tabset}
### Vanilla shiny 

* `fluidPage()`: dise√±o fluido, se adapta al tama√±o de la ventana
* `fixedPage()`: dise√±o fijo, no se adapta al tama√±o de la ventana
* `navbarPage()`: dise√±o con barra de navegaci√≥n superior
* `sidebarPage()`: dise√±o con barra lateral izquierda
* `sidebarLayout()`: dise√±o con barra lateral izquierda y panel principal

### {bslib}

* `page_navbar()`: dise√±o con barra de navegaci√≥n superior
* `page_sidebar()`: dise√±o con barra lateral izquierda
* `page_fluid()`: dise√±o fluido, se adapta al tama√±o de la ventana  
* `page_fixed()`: dise√±o fijo, no se adapta al tama√±o de la ventana

:::


## Ejemplo con `bslib`

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)

ui <- page_navbar(
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(title = "Selecci√≥n"),
  nav_panel(title = "Resultados"),
  nav_panel(title = "Goleadores")
)

server <- function(input, output, session) {}

shinyApp(ui, server)
```


## Sidebars

* El sidebar es un contenedor en s√≠ mismo, se puede incluir cualquier elemento.

* Principales opciones: ancho, posici√≥n, abierto, , t√≠tulo.

* Barras adicionales con `layout_sidebar()`


```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)

ui <- page_navbar(
  title = "An√°lisis resultados FIFA",
  p("Contenido principal"),
  layout_sidebar(
    sidebar = sidebar(title = "Selecci√≥n"),
    layout_sidebar(
      sidebar = sidebar(title = "Filtros"),
      position = "right",
      open = FALSE
    )
  ),
  nav_panel(title = "Resultados"),
  nav_panel(title = "Goleadores")
)

server <- function(input, output, session) {}

shinyApp(ui, server)
```


## Pesta√±as (tabs)

* Permiten organizar el contenido en secciones dentro de la misma p√°gina

* Estructura: `navset_*()` para el contenedor de pesta√±as, `nav_panel()` para cada pesta√±a

* `pill`s: estilo de pesta√±as con bordes redondeados

* `card`s: estilo de pesta√±as con fondo y bordes, similar a las tarjetas

* `tab`'s: estilo de pesta√±as cl√°sico, sin bordes ni fondo

* `list`'s: pesta√±as en vertical

## Cards

* Contenedores con estilo para agrupar elementos relacionados

* Personalizables con t√≠tulos, colores, iconos, etc.

* Ancho completo o dividido en filas y columnas

## Ejemplo con {bslib}

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)

ui <- page_navbar(
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(title = "Selecci√≥n"),
  nav_panel(
    title = "Resultados",
    layout_columns(
      col_widths = c(2, 10),
      card(
        title = "Resultados por selecci√≥n",
        p("Contenido de la tarjeta")
      ),
      card(
        title = "Resultados por torneo",
        p("Contenido de la tarjeta")
      )
    )
  ),
  nav_panel(
    title = "Goleadores",
    navset_pill(
      nav_panel(
        title = "Goleadores por selecci√≥n",
        p("Contenido de la pesta√±a 1")
      ),
      nav_panel(title = "Goleadores por torneo", p("Contenido de la pesta√±a 2"))
    )
  )
)

server <- function(input, output, session) {}

shinyApp(ui, server)
```

## Componentes - inputs

* **Cajas de texto**: num√©ricas, texto, texto multilina, fecha, contrase√±a

* **Acciones**: bot√≥n, bot√≥n de tarea, link, descarga, upload, submit

* **Selecci√≥n**: checkbox, checkbox group, select, slider, rangos

* Selectize vs select cl√°sico: m√°s opciones

* **shinywidgets**: amplia variedad de widgets adicionales, como selectize con b√∫squeda, sliders con rangos personalizados, etc. Otros paquetes que ofrecen componentes adicionales.

* **Paneles condicionales**: seg√∫n selecciones en el UI se muestran o no

[shiny components](https://shiny.posit.co/r/components/) | [shinywidgets](https://shinywidgets.com/) 

## Componentes - outputs

* **Textos**: texto, texto HTML, verbatim text
* **Tablas**: tabla renderizada, tabla interactiva (DT, reactable, gt)
* **Gr√°ficos**: gr√°ficos est√°ticos (ggplot2, base), 
* **Gr√°ficos interactivos**: plotly, echarts4r, highcharter, ggiraph, etc.
* **Mapas**: leaflet, mapview, tmap, etc.
* **Im√°genes**
* **Diagramas**: diagrammeR, mermaid, etc.
+ **ValueBox**: cajas de valor para mostrar m√©tricas clave de forma destacada
* **UI**: controles que se generan en el server (porque dependen de inputs o datos)


## Ejemplo: paneles condicionales

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
resultados <- read.csv("data/results.csv")
ui <- page_navbar(
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(
    title = "Selecci√≥n",
    selectizeInput(
      "sel_pais",
      "Selecciona un pa√≠s:",
      choices = unique(resultados$home_team)
    ),
    checkboxInput("chk_partidos", "Mostrar n√∫mero partidos", value = FALSE),
  ),
  nav_panel(
    title = "Partidos",
    reactableOutput("tabla_partidos"),
    conditionalPanel(
      condition = "input.chk_partidos == true",
      verbatimTextOutput("num_partidos")
    )
  ),
  nav_panel(title = "Goleadores")
)

server <- function(input, output, session) {
  output$tabla_partidos <- renderReactable({
    resultados |>
      filter(home_team == input$sel_pais) |>
      reactable()
  })

  output$num_partidos <- renderPrint({
    num <- resultados |>
      filter(home_team == input$sel_pais) |>
      nrow()
    paste("N√∫mero de partidos:", num)
  })
}

shinyApp(ui, server)
```




## Ejemplo: UI din√°mica

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
resultados <- read.csv("data/results.csv")
goleadores <- read.csv("data/goalscorers.csv")
ui <- page_navbar(
  selected = "Goleadores",
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(
    title = "Selecci√≥n",
    selectizeInput(
      "sel_pais",
      "Selecciona un pa√≠s:",
      choices = unique(resultados$home_team)
    ),
    uiOutput("ui_jugadores")
  ),
  nav_panel(
    title = "Partidos"
  ),
  nav_panel(title = "Goleadores", reactableOutput("tabla_jugadores"))
)

server <- function(input, output, session) {
  output$ui_jugadores <- renderUI({
    jugadores <- goleadores |>
      filter(home_team == input$sel_pais) |>
      pull(scorer) |>
      unique()
    selectizeInput("sel_jugador", "Selecciona un jugador:", choices = jugadores)
  })
  output$tabla_jugadores <- renderReactable({
    goleadores |>
      filter(home_team == input$sel_pais, scorer == input$sel_jugador) |>
      reactable()
  })
}

shinyApp(ui, server)
```

# Interacci√≥n con el usuario

## Interacci√≥n con el usuario: mensajes

* `showNotification()`: muestra un mensaje temporal en la parte superior de la app, con opciones de tipo (info, success, warning, error), duraci√≥n, etc.

* `showModal()`: muestra un cuadro de di√°logo modal con contenido personalizado, como texto, im√°genes, inputs, etc.

* `showAlert()`: muestra un mensaje de alerta con opciones de tipo, t√≠tulo, texto, etc.

* Con shinywidgets: via sweetalert

## Ejemplo botones y mensajes (shiny vanilla)


```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(dplyr)
resultados <- read.csv("data/results.csv")
ui <- page_sidebar(
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(
    title = "Selecci√≥n",
    selectizeInput(
      "sel_pais",
      "Selecciona un pa√≠s:",
      choices = unique(resultados$home_team)
    )
  ),
  actionButton("btn_mensaje", "Mostrar mensaje"),
  actionLink("lnk_mensaje", "Mostrar mensaje con link")
)

server <- function(input, output, session) {
  observeEvent(input$btn_mensaje, {
    showNotification(
      paste("Has seleccionado:", input$sel_pais),
      type = "message"
    )
  })
  observeEvent(input$lnk_mensaje, {
    showModal(
      modalDialog(
        title = "Mensaje",
        paste("Has seleccionado:", input$sel_pais),
        footer = tagList(
          modalButton("Cerrar"),
          actionButton("btn_mas_info", "M√°s info")
        )
      )
    )
  })
}

shinyApp(ui, server)
```

## Ejemplo shinyWidgets - sweetalert

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(dplyr)
library(shinyWidgets)
resultados <- read.csv("data/results.csv")
ui <- page_sidebar(
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(
    title = "Selecci√≥n",
    selectizeInput(
      "sel_pais",
      "Selecciona un pa√≠s:",
      choices = unique(resultados$home_team)
    )
  ),
  actionButton("btn_mensaje", "Mostrar mensaje sweet"),
)

server <- function(input, output, session) {
  observeEvent(input$btn_mensaje, {
    show_alert(
      title = "√âxito !!",
      text = "Todo en orden",
      type = "success"
    )
  })
}

shinyApp(ui, server)
```

## Validaci√≥n

* `validate()` y `need()`: permiten validar condiciones en el server y mostrar mensajes de error personalizados en lugar de errores gen√©ricos.

* `req()`: requiere que un input o valor est√© presente y no sea NULL o vac√≠o, de lo contrario detiene la ejecuci√≥n. Lo veremos en la siguiente sesi√≥n sobre reactividad.

* [{shinyvalidate}](https://rstudio.github.io/shinyvalidate/): ofrece un mayor control sobre la validaci√≥n, con reglas predefinidas, mensajes personalizados, validaci√≥n en tiempo real, etc.

## Ejemplo validaci√≥n

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
library(lubridate)
resultados <- read.csv("data/results.csv")
ui <- page_navbar(
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(
    title = "Selecci√≥n",
    selectizeInput(
      "sel_pais",
      "Selecciona un pa√≠s:",
      choices = unique(resultados$home_team)
    ),
    numericInput("year", "Selecciona un a√±o:", value = 2022, min = 1956, max = 2025)
  ),
  nav_panel(
    title = "Partidos",
    reactableOutput("tabla_partidos"),
    
  ),
  nav_panel(title = "Goles",
  plotOutput("graf_goles")
  )
)

server <- function(input, output, session) {
  output$tabla_partidos <- renderReactable({
    resultados |>
      filter(home_team == input$sel_pais) |>
      reactable()
  })

  output$graf_goles <- renderPlot({
    validate(
      need(input$year > 2000, "Solo se muestran datos a partir del a√±o 2000")
    )
datos <- resultados |>
      filter(home_team == input$sel_pais, year(date) == input$year) |>
      group_by(tournament) |>
      summarise(diferencia = sum(home_score - away_score))

    barplot(datos$diferencia, names.arg = datos$tournament, col = "steelblue", main = "Diferencia de goles por torneo", ylab = "Diferencia de goles")
  })
}

shinyApp(ui, server)
```

# Temas y estilos

## Temas y personalizaci√≥n

* Elegir un tema completo con `bs_theme()`

* Se pueden previsualizar todos con `bs_themer()` y ver c√≥mo queda nuestro dashboard

* Se pueden cambiar componentes espec√≠ficos en `bs_theme()`, o bien personalizar `  bs_add_variables()`


## Ejemplo previsualizaci√≥n de temas

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
resultados <- read.csv("data/results.csv")
goleadores <- read.csv("data/goalscorers.csv")
ui <- page_navbar(
  selected = "Goleadores",
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(
    title = "Selecci√≥n",
    selectizeInput(
      "sel_pais",
      "Selecciona un pa√≠s:",
      choices = unique(resultados$home_team)
    ),
    uiOutput("ui_jugadores")
  ),
  nav_panel(
    title = "Partidos"
  ),
  nav_panel(title = "Goleadores", reactableOutput("tabla_jugadores"))
)

server <- function(input, output, session) {
  bs_themer()
  output$ui_jugadores <- renderUI({
    jugadores <- goleadores |>
      filter(home_team == input$sel_pais) |>
      pull(scorer) |>
      unique()
    selectizeInput("sel_jugador", "Selecciona un jugador:", choices = jugadores)
  })
  output$tabla_jugadores <- renderReactable({
    goleadores |>
      filter(home_team == input$sel_pais, scorer == input$sel_jugador) |>
      reactable()
  })
}

shinyApp(ui, server)
```


## Ejemplo establecer tema

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
resultados <- read.csv("data/results.csv")
goleadores <- read.csv("data/goalscorers.csv")
ui <- page_navbar(
  theme = bs_theme(bootswatch = "minty"),
  selected = "Goleadores",
  title = "An√°lisis resultados FIFA",
  sidebar = sidebar(
    title = "Selecci√≥n",
    selectizeInput(
      "sel_pais",
      "Selecciona un pa√≠s:",
      choices = unique(resultados$home_team)
    ),
    uiOutput("ui_jugadores")
  ),
  nav_panel(
    title = "Partidos"
  ),
  nav_panel(title = "Goleadores", reactableOutput("tabla_jugadores"))
)

server <- function(input, output, session) {
  output$ui_jugadores <- renderUI({
    jugadores <- goleadores |>
      filter(home_team == input$sel_pais) |>
      pull(scorer) |>
      unique()
    selectizeInput("sel_jugador", "Selecciona un jugador:", choices = jugadores)
  })
  output$tabla_jugadores <- renderReactable({
    goleadores |>
      filter(home_team == input$sel_pais, scorer == input$sel_jugador) |>
      reactable()
  })
}

shinyApp(ui, server)
```




# Preguntas? 



[http://emilio.lcano.com](https://emilio.lcano.com)

[emilio.lopez@urjc.es]{.red}


\

¬°Gracias!
  
:::{style="text-align:center"}
üñ•Ô∏è Live demo ü§ûüèª
:::
  
  
  