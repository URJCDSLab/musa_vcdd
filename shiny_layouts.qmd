---
title: Diseño e interacción de usuario con Shiny
subtitle: "Visualización y Comunicación de Datos Deportivos"
author: "Máster Universitario en Análisis de Datos Deportivos<br/>Universidad Rey Juan Carlos"
code-fold: false
---

# Paquetes y metapaquetes para dashboards

## Conjuntos de paquetes

* Proporcionan una estructura y un diseño predefinido

* Aceleran el desarrollo

* Automatizan tareas comunes

* Personalización limitada

* Ejemplos: [golemverse](https://golemverse.org), [rhinoverse](https://www.appsilon.com/rhinoverse), [leprechaun](https://leprechaun.opifex.org/#/)

## Ejemplo con Rhino

```{r}
#| eval: false
#| echo: true
# install.packages("rhino")
rhino::init("RhinoApplication")
setwd("./RhinoApplication")
shiny::runApp()
```


## Paquetes generalistas

* Menos dependientes de un diseño específico

* [shinydashboard](https://rstudio.github.io/shinydashboard/). Obsoleto, pero aún muy utilizado.

* [b4dash](https://github.com/ThinkR-open/b4dash). Basado en Bootstrap 4, más moderno y flexible.

* [bslib](https://rstudio.github.io/bslib/). Permite crear temas personalizados para Shiny, incluyendo dashboards.

* [shinywidgets](https://shinywidgets.com/). Colección de widgets y componentes para Shiny, incluyendo algunos para dashboards.

## App dentro de un paquete propio

* Recomendado para proyectos complejos o a largo plazo

* Facilita la organización del código, la reutilización de componentes y la colaboración

* Permite la integración con otras funciones y datos del paquete

* Detalles: [https://mjfrigaard.github.io/shiny-app-pkgs/](https://mjfrigaard.github.io/shiny-app-pkgs/)

* IMPORTANTE: manejo de paquetes con `NAMESPACE`, no `library()`.



# Diseño (layouts)

## Estructura general de un dashboard
  
* Primero se define el tipo de página

* Dependiendo del tipo de página, puede incluir o no una barra lateral (incluso una a cada lado)

* Se puede añadir pie de página

* Panel principal: pensar en filas y columnas (_bootstrap grid system_, 12 columnas)

* Organización de panel principal y _sidebar_ con pestañas.

* Incluir elementos en _cards_ o _boxes_.


## Diseños de página

::: {.panel-tabset}
### Vanilla shiny 

* `fluidPage()`: diseño fluido, se adapta al tamaño de la ventana
* `fixedPage()`: diseño fijo, no se adapta al tamaño de la ventana
* `navbarPage()`: diseño con barra de navegación superior
* `sidebarPage()`: diseño con barra lateral izquierda
* `sidebarLayout()`: diseño con barra lateral izquierda y panel principal

### {bslib}

* `page_navbar()`: diseño con barra de navegación superior
* `page_sidebar()`: diseño con barra lateral izquierda
* `page_fluid()`: diseño fluido, se adapta al tamaño de la ventana  
* `page_fixed()`: diseño fijo, no se adapta al tamaño de la ventana

:::


## Ejemplo con `bslib`

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)

ui <- page_navbar(
  title = "Análisis resultados FIFA",
  sidebar = sidebar(title = "Selección"),
  nav_panel(title = "Resultados"),
  nav_panel(title = "Goleadores")
)

server <- function(input, output, session) {}

shinyApp(ui, server)
```


## Sidebars

* El sidebar es un contenedor en sí mismo, se puede incluir cualquier elemento.

* Principales opciones: ancho, posición, abierto, , título.

* Barras adicionales con `layout_sidebar()`


```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)

ui <- page_navbar(
  title = "Análisis resultados FIFA",
  p("Contenido principal"),
  layout_sidebar(
    sidebar = sidebar(title = "Selección"),
    layout_sidebar(
      sidebar = sidebar(title = "Filtros"),
      position = "right",
      open = FALSE
    )
  ),
  nav_panel(title = "Resultados"),
  nav_panel(title = "Goleadores")
)

server <- function(input, output, session) {}

shinyApp(ui, server)
```


## Pestañas (tabs)

* Permiten organizar el contenido en secciones dentro de la misma página

* Estructura: `navset_*()` para el contenedor de pestañas, `nav_panel()` para cada pestaña

* `pill`s: estilo de pestañas con bordes redondeados

* `card`s: estilo de pestañas con fondo y bordes, similar a las tarjetas

* `tab`'s: estilo de pestañas clásico, sin bordes ni fondo

* `list`'s: pestañas en vertical

## Cards

* Contenedores con estilo para agrupar elementos relacionados

* Personalizables con títulos, colores, iconos, etc.

* Ancho completo o dividido en filas y columnas

## Ejemplo con {bslib}

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)

ui <- page_navbar(
  title = "Análisis resultados FIFA",
  sidebar = sidebar(title = "Selección"),
  nav_panel(
    title = "Resultados",
    layout_columns(
      col_widths = c(2, 10),
      card(
        card_header("Resultados por selección"),
        card_body(p("Contenido de la tarjeta"))
      ),
      card(
        card_header("Resultados por torneo"),
        card_body(p("Contenido de la tarjeta")) 
      )
    )
  ),
  nav_panel(
    title = "Goleadores",
    navset_pill(
      nav_panel(
        title = "Goleadores por selección",
        p("Contenido de la pestaña 1")
      ),
      nav_panel(title = "Goleadores por torneo", p("Contenido de la pestaña 2"))
    )
  )
)

server <- function(input, output, session) {}

shinyApp(ui, server)
```

## Componentes - inputs

* **Cajas de texto**: numéricas, texto, texto multilina, fecha, contraseña

* **Acciones**: botón, botón de tarea, link, descarga, upload, submit

* **Selección**: checkbox, checkbox group, select, slider, rangos

* Selectize vs select clásico: más opciones

* **shinywidgets**: amplia variedad de widgets adicionales, como selectize con búsqueda, sliders con rangos personalizados, etc. Otros paquetes que ofrecen componentes adicionales.

* **Paneles condicionales**: según selecciones en el UI se muestran o no

[shiny components](https://shiny.posit.co/r/components/) | [shinywidgets](https://shinywidgets.com/) 

## Componentes - outputs

* **Textos**: texto, texto HTML, verbatim text
* **Tablas**: tabla renderizada, tabla interactiva (DT, reactable, gt)
* **Gráficos**: gráficos estáticos (ggplot2, base), 
* **Gráficos interactivos**: plotly, echarts4r, highcharter, ggiraph, etc.
* **Mapas**: leaflet, mapview, tmap, etc.
* **Imágenes**
* **Diagramas**: diagrammeR, mermaid, etc.
+ **ValueBox**: cajas de valor para mostrar métricas clave de forma destacada
* **UI**: controles que se generan en el server (porque dependen de inputs o datos)


## Ejemplo: paneles condicionales

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
resultados <- read.csv("data/results.csv")
ui <- page_navbar(
  title = "Análisis resultados FIFA",
  sidebar = sidebar(
    title = "Selección",
    selectizeInput(
      "sel_pais",
      "Selecciona un país:",
      choices = unique(resultados$home_team)
    ),
    checkboxInput("chk_partidos", "Mostrar número partidos", value = FALSE),
  ),
  nav_panel(
    title = "Partidos",
    reactableOutput("tabla_partidos"),
    conditionalPanel(
      condition = "input.chk_partidos == true",
      verbatimTextOutput("num_partidos")
    )
  ),
  nav_panel(title = "Goleadores")
)

server <- function(input, output, session) {
  output$tabla_partidos <- renderReactable({
    resultados |>
      filter(home_team == input$sel_pais) |>
      reactable()
  })

  output$num_partidos <- renderPrint({
    num <- resultados |>
      filter(home_team == input$sel_pais) |>
      nrow()
    paste("Número de partidos:", num)
  })
}

shinyApp(ui, server)
```




## Ejemplo: UI dinámica

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
resultados <- read.csv("data/results.csv")
goleadores <- read.csv("data/goalscorers.csv")
ui <- page_navbar(
  selected = "Goleadores",
  title = "Análisis resultados FIFA",
  sidebar = sidebar(
    title = "Selección",
    selectizeInput(
      "sel_pais",
      "Selecciona un país:",
      choices = unique(resultados$home_team)
    ),
    uiOutput("ui_jugadores")
  ),
  nav_panel(
    title = "Partidos"
  ),
  nav_panel(title = "Goleadores", reactableOutput("tabla_jugadores"))
)

server <- function(input, output, session) {
  output$ui_jugadores <- renderUI({
    jugadores <- goleadores |>
      filter(home_team == input$sel_pais) |>
      pull(scorer) |>
      unique()
    selectizeInput("sel_jugador", "Selecciona un jugador:", choices = jugadores)
  })
  output$tabla_jugadores <- renderReactable({
    goleadores |>
      filter(home_team == input$sel_pais, scorer == input$sel_jugador) |>
      reactable()
  })
}

shinyApp(ui, server)
```

# Interacción con el usuario

## Interacción con el usuario: mensajes

* `showNotification()`: muestra un mensaje temporal en la parte superior de la app, con opciones de tipo (info, success, warning, error), duración, etc.

* `showModal()`: muestra un cuadro de diálogo modal con contenido personalizado, como texto, imágenes, inputs, etc.

* `showAlert()`: muestra un mensaje de alerta con opciones de tipo, título, texto, etc.

* Con shinywidgets: via sweetalert

## Ejemplo botones y mensajes (shiny vanilla)


```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(dplyr)
resultados <- read.csv("data/results.csv")
ui <- page_sidebar(
  title = "Análisis resultados FIFA",
  sidebar = sidebar(
    title = "Selección",
    selectizeInput(
      "sel_pais",
      "Selecciona un país:",
      choices = unique(resultados$home_team)
    )
  ),
  actionButton("btn_mensaje", "Mostrar mensaje"),
  actionLink("lnk_mensaje", "Mostrar mensaje con link")
)

server <- function(input, output, session) {
  observeEvent(input$btn_mensaje, {
    showNotification(
      paste("Has seleccionado:", input$sel_pais),
      type = "message"
    )
  })
  observeEvent(input$lnk_mensaje, {
    showModal(
      modalDialog(
        title = "Mensaje",
        paste("Has seleccionado:", input$sel_pais),
        footer = tagList(
          modalButton("Cerrar"),
          actionButton("btn_mas_info", "Más info")
        )
      )
    )
  })
}

shinyApp(ui, server)
```

## Ejemplo shinyWidgets - sweetalert

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(dplyr)
library(shinyWidgets)
resultados <- read.csv("data/results.csv")
ui <- page_sidebar(
  title = "Análisis resultados FIFA",
  sidebar = sidebar(
    title = "Selección",
    selectizeInput(
      "sel_pais",
      "Selecciona un país:",
      choices = unique(resultados$home_team)
    )
  ),
  actionButton("btn_mensaje", "Mostrar mensaje sweet"),
)

server <- function(input, output, session) {
  observeEvent(input$btn_mensaje, {
    show_alert(
      title = "Éxito !!",
      text = "Todo en orden",
      type = "success"
    )
  })
}

shinyApp(ui, server)
```

## Validación

* `validate()` y `need()`: permiten validar condiciones en el server y mostrar mensajes de error personalizados en lugar de errores genéricos.

* `req()`: requiere que un input o valor esté presente y no sea NULL o vacío, de lo contrario detiene la ejecución. Lo veremos en la siguiente sesión sobre reactividad.

* [{shinyvalidate}](https://rstudio.github.io/shinyvalidate/): ofrece un mayor control sobre la validación, con reglas predefinidas, mensajes personalizados, validación en tiempo real, etc.

## Ejemplo validación

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
library(lubridate)
resultados <- read.csv("data/results.csv")
ui <- page_navbar(
  title = "Análisis resultados FIFA",
  sidebar = sidebar(
    title = "Selección",
    selectizeInput(
      "sel_pais",
      "Selecciona un país:",
      choices = unique(resultados$home_team)
    ),
    numericInput("year", "Selecciona un año:", value = 2022, min = 1956, max = 2025)
  ),
  nav_panel(
    title = "Partidos",
    reactableOutput("tabla_partidos"),
    
  ),
  nav_panel(title = "Goles",
  plotOutput("graf_goles")
  )
)

server <- function(input, output, session) {
  output$tabla_partidos <- renderReactable({
    resultados |>
      filter(home_team == input$sel_pais) |>
      reactable()
  })

  output$graf_goles <- renderPlot({
    validate(
      need(input$year > 2000, "Solo se muestran datos a partir del año 2000")
    )
datos <- resultados |>
      filter(home_team == input$sel_pais, year(date) == input$year) |>
      group_by(tournament) |>
      summarise(diferencia = sum(home_score - away_score))

    barplot(datos$diferencia, names.arg = datos$tournament, col = "steelblue", main = "Diferencia de goles por torneo", ylab = "Diferencia de goles")
  })
}

shinyApp(ui, server)
```

# Temas y estilos

## Temas y personalización

* Elegir un tema completo con `bs_theme()`

* Se pueden previsualizar todos con `bs_themer()` y ver cómo queda nuestro dashboard

* Se pueden cambiar componentes específicos en `bs_theme()`, o bien personalizar `  bs_add_variables()`


## Ejemplo previsualización de temas

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
resultados <- read.csv("data/results.csv")
goleadores <- read.csv("data/goalscorers.csv")
ui <- page_navbar(
  selected = "Goleadores",
  title = "Análisis resultados FIFA",
  sidebar = sidebar(
    title = "Selección",
    selectizeInput(
      "sel_pais",
      "Selecciona un país:",
      choices = unique(resultados$home_team)
    ),
    uiOutput("ui_jugadores")
  ),
  nav_panel(
    title = "Partidos"
  ),
  nav_panel(title = "Goleadores", reactableOutput("tabla_jugadores"))
)

server <- function(input, output, session) {
  bs_themer()
  output$ui_jugadores <- renderUI({
    jugadores <- goleadores |>
      filter(home_team == input$sel_pais) |>
      pull(scorer) |>
      unique()
    selectizeInput("sel_jugador", "Selecciona un jugador:", choices = jugadores)
  })
  output$tabla_jugadores <- renderReactable({
    goleadores |>
      filter(home_team == input$sel_pais, scorer == input$sel_jugador) |>
      reactable()
  })
}

shinyApp(ui, server)
```


## Ejemplo establecer tema

```{r}
#| eval: false
#| echo: true
library(shiny)
library(bslib)
library(reactable)
library(dplyr)
resultados <- read.csv("data/results.csv")
goleadores <- read.csv("data/goalscorers.csv")
ui <- page_navbar(
  theme = bs_theme(bootswatch = "minty"),
  selected = "Goleadores",
  title = "Análisis resultados FIFA",
  sidebar = sidebar(
    title = "Selección",
    selectizeInput(
      "sel_pais",
      "Selecciona un país:",
      choices = unique(resultados$home_team)
    ),
    uiOutput("ui_jugadores")
  ),
  nav_panel(
    title = "Partidos"
  ),
  nav_panel(title = "Goleadores", reactableOutput("tabla_jugadores"))
)

server <- function(input, output, session) {
  output$ui_jugadores <- renderUI({
    jugadores <- goleadores |>
      filter(home_team == input$sel_pais) |>
      pull(scorer) |>
      unique()
    selectizeInput("sel_jugador", "Selecciona un jugador:", choices = jugadores)
  })
  output$tabla_jugadores <- renderReactable({
    goleadores |>
      filter(home_team == input$sel_pais, scorer == input$sel_jugador) |>
      reactable()
  })
}

shinyApp(ui, server)
```




# Preguntas? 



[http://emilio.lcano.com](https://emilio.lcano.com)

[emilio.lopez@urjc.es]{.red}


\

¡Gracias!
  

  
  
  